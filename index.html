<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Portal Messenger</title>
		<link rel="stylesheet" type="text/css" href="static/styles.css">
		<link rel="stylesheet" type="text/css" href="static/media.css">
		<link rel="stylesheet" type="text/css" href="static/dark.css">
		<link rel="icon" type="image/x-icon" href="static/icons/double_arrow.svg">
		<script src="static/jquery.min.js"></script>
		<script src="static/socket.io.min.js"></script>
		<script src="static/common.js"></script>
		<script src="static/stations.js"></script>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
    </head>
    <body>
	    <div class="header">
			PORTAL MESSENGER
		    <a href="/portalmessenger/settings.html"><span class="icon icon-settings">&nbsp;</span></a>
		</div>
		<div class="details tab-container">
			<div class="details-name tab selected" id="tab-activity">Activity</div>
			<div class="details-name tab" id="tab-conversations">Messages
				<span id="unread-count" data-unread-count="1">(1)</span>
			</div>
		</div>
		<div class="viewport">
			<div class="content">

				<div class="station spot" name="OH8STN">
					<div class="presence-indicator presence-active">&nbsp;</div>
					<div class="chat-name">OH8STN</div>
					<div class="last-heard">2 minutes</div>
				</div>

				<div class="station spot conversation"name="KT7RUN">
					<div class="presence-indicator presence-active">&nbsp;</div>
					<div class="chat-name">KT7RUN</div>
					<div class="last-heard">8 minutes</div>
				</div>
				
				<div class="station spot" name="@AMRRON">
					<div class="presence-indicator presence-inactive">&nbsp;</div>
					<div class="chat-name">@AMRRON</div>
					<div class="last-heard">22 hours</div>
				</div>

				<div class="station spot" name="N0GQ">
					<div class="presence-indicator presence-unknown">&nbsp;</div>
					<div class="chat-name">N0GQ</div>
					<div class="last-heard">&nbsp;</div>
				</div>
				
				<!-- hidden element for cloning -->
				<div class="station original-hidden">
					<div class="presence-indicator presence-unknown">&nbsp;</div>
					<div class="chat-name">&nbsp;</div>
					<div class="last-heard">&nbsp;</div>
				</div>

			</div>

		</div>
		<div class="footer">
			<span class="icon icon-add">&nbsp;</span>
			<form id="new-conversation-form">
				<input type="text" id="new-conversation" placeholder="Type user here..." autofocus autocomplete="off"/>
				<button type="submit" id="new-conversation-button">Add</button>
			</form>
		</div>

    </body>
	<script>
        //var socket = io.connect('http://' + document.domain + ':' + location.port);

		//socket.on('spot', function( data ) {
		//	data.forEach(function( station ) {
		//		handleSpot(station);
		//	});
		//	sortStations();
        //    // click selected tab to force above event handling
        //    $('.tab.selected').click();
		//});

		//socket.on('conversation', function( data ) {
		//	data.forEach(function( station ) {
		//		handleConversation(station);
		//	});
		//	sortStations();
        //    // click selected tab to force above event handling
        //    $('.tab.selected').click();
		//});

		$(window).on('load', function(){
			// setup click callbacks
			$('#tab-activity').click(function(){
				$('#tab-conversations').removeClass('selected');
				$('#tab-activity').addClass('selected');
				// show spots, including conversations that are also spots
				$('.conversation').hide();
				$('.spot').show();
			});

			$('#tab-conversations').click(function(){
				$('#tab-activity').removeClass('selected');
				$('#tab-conversations').addClass('selected');
				// show conversations, including spots that are also conversations
				$('.spot').hide();
				$('.conversation').show();
			});

			$('.icon-add').click(function(){
				$('.icon-add').hide();
				$('#new-conversation-form').val('');
				$('#new-conversation-form').show();
				$('#new-conversation').focus();
			});

			$('#new-conversation-form').submit(function (){
				event.preventDefault();
				username = $('#new-conversation').val().trim().toUpperCase();
				//$.post('/stations', {user: username}, function() {
					window.location = '/portalmessenger/chat.html?' + $('.tab.selected').attr('id') + '&' + username + '&unknown';
				//});
			});
			
            $('.station').each(function() {
                $(this).click(stationClick)
            });

			// request station data from the server
			//socket.emit('spot');
			//socket.emit('conversation');

            // click selected tab to force above event handling
            // return to previously selected tab if returning from another page
            if ( window.location.search.substring(1).split('&')[0] == '' ) {
                $('.tab.selected').click();
            }
            else {
                $('#' + window.location.search.substring(1).split('&')[0]).click();
            }
		});

		// update last heard text and presence, client side
		setInterval(function() {
			$('.station').not('.original-hidden').each(function() {
				username = $(this).attr('name');
				timestamp = parseInt( $(this).find('.last-heard').attr('data-last-heard') );

				// cull spots older than 10 miuntes
				if ( $(this).hasClass('spot') ) {
			        now = new Date();
					then = new Date( timestamp * 1000 );
					lastHeardMinutes = Math.floor( ((now - then) / 1000) / 60 );

					if ( lastHeardMinutes >= parseInt( $('#tab-activity').attr('data-aging') ) ) {
                        if ( $(this).hasClass('conversation') ) {
                            $(this).removeClass('spot');

                            if ( selectedTab() == 'activity' ) {
                                $(this).hide();
                            }
                        }
				        else {
						    $(this).remove();
						    // continue with next iteration
						    return true;
                        }
					}
				}

				setLastHeard(username, timestamp);
			});
		}, 1000 * 60);

	</script>
</html>
