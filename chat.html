<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Portal Messenger</title>
		<link rel="stylesheet" type="text/css" href="static/styles.css">
		<link rel="stylesheet" type="text/css" href="static/media.css">
		<link rel="stylesheet" type="text/css" href="static/dark.css">
		<link rel="icon" type="image/x-icon" href="static/icons/double_arrow.svg">
		<script src="static/jquery.min.js"></script>
		<script src="static/socket.io.min.js"></script>
		<script src="static/common.js"></script>
		<script src="static/chat.js"></script>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
    </head>
    <body>
	    <div class="header">
			PORTAL MESSENGER
		    <a href="javascript:window.location = document.referrer;"><span class="icon icon-back icon-back-chat">&nbsp;</span></a>
		    <span class="icon icon-vertical-ellipsis">&nbsp;</span>
		</div>
        <div class="menu-container"><div class="menu">
            <div class="menu-item" value="MSG [text]">Inbox Message</div>
            <div class="menu-item" value="MSG TO:[callsign] [text]">Store Inbox Message</div>
            <div class="menu-item" value="QUERY MSGS?">Query Messages</div>
            <div class="menu-item" value="QUERY MSG [ID]">Query Message ID</div>
            <div class="menu-item" value="SNR?">Query SNR</div>
            <div class="menu-item" value="HEARING?">Query Hearing</div>
            <div class="menu-item" value="QUERY CALL [callsign]">Query Callsign</div>
            <div class="menu-item" value="GRID?">Query Grid Square</div>
            <div class="menu-item" value="INFO?">Query Info</div>
            <div class="menu-item" value="STATUS?">Query Status</div>
        </div></div>
		<div class="details chat-details">
			<div class="presence-indicator presence-unknown">&nbsp;</div>
			<div class="chat-name">&nbsp;</div>
			<div class="last-heard">&nbsp;</div>
		</div>
		<div class="viewport">
            <div class="content chat-messages">

                <!-- hidden original for cloning -->
				<div class="original-hidden"><div class="chat-bubble">
					<div class="chat-msg">&nbsp;</div>
					<div class="chat-time">&nbsp;</div>
				</div><div class="chat-status">&nbsp;</div></div>

			</div>
		</div>
		<div class="footer">
			<form id="chat-text-form">
				<input type="text" id="chat-text" placeholder="Type a message here..." autofocus autocomplete="off"/>
				<button type="submit" id="chat-send-button">Send</button>
			</form>
		</div>

    </body>
	<script>
        //var socket = io.connect('http://' + document.domain + ':' + location.port);

        //socket.on('connect', function() {
        //    socket.emit('log', {msg: 'Connected to socket'});
        //});

        //NEW menu code
        $('.menu').hide();

        $('span.icon-back-chat').parent().attr('href', '/portalmessenger/index.html?' + window.location.search.substring(1).split('&')[0])

        //socket.on('msg', function( msgs ) {
		//	msgs.forEach(function ( msg ) {
		//		newChatMessage(msg)
		//	});
		//
		//	// sort first loading msgs
		//	if (msgs.length > 1) {
		//		sortChat();
		//	}
		//
		//	scrollChat();
        //});

		//socket.on('update-tx-status', function ( data ) {
		//	setTxStatus(data.id, data.status);
		//});

		//socket.on('heard-user', function ( last_heard ) {
		//	setLastHeard(last_heard);
		//});

		$('#chat-text-form').submit(function( event ){
			event.preventDefault();
            //NEW menu code
            cmd = Boolean($('#chat-text-form').attr('data-cmd'));
            //TODO handle directed command on server side
			//socket.emit('msg', {user: $('.chat-name').html(), text: $('#chat-text').val()})
			$('#chat-text').val('');

            msgId = parseInt(Math.random() * 100000000000000000);
			tx_msg = {'id': msgId, 'type': 'tx', 'time': String( (Date.now() / 1000)), 'text': $('#chat-text').val(), 'status': 'sending', 'error': null};
			newChatMessage(tx_msg);

            setTimeout(function (){
                updateTxStatus(msgId, 'sent');
            }, 12);
		});

		$(window).on('load', function(){
			//socket.emit('init-chat');
			//socket.emit('heard-user', {user: $('.chat-name').html()});
            urlParam = window.location.search.substring(1).split('&');
			$('.chat-name').html( urlParam[1] );
		    setLastHeard( urlParam[2] );
			
			if ( $('.chat-name').html() == 'KT7RUN' ) {
				rx_msg = {'id': 'abc123', 'type': 'rx', 'time': String( (Date.now() / 1000) - 120), 'text': 'NEW VIDEO ON YOUTUBE', 'status': null, 'error': null};
				tx_msg = {'id': '123abc', 'type': 'tx', 'time': String( (Date.now() / 1000)), 'text': 'GREAT NEWS THX', 'status': null, 'error': null};
				newChatMessage(rx_msg);
				newChatMessage(tx_msg);
				sortChat();
				scrollChat();
			}

            //NEW menu code
            $('.icon-vertical-ellipsis').click(function (){
                $('.menu').slideToggle();
            });

            //NEW menu code
            $('.menu-item').click(function (){
                $('#chat-text-form').attr('data-cmd', true);
                $('#chat-text').val( $(this).attr('value') );
                $('.menu').slideUp();
                $('#chat-text').focus();
            });
		});

		setInterval(function (){
			setLastHeard( parseInt( $('.last-heard').attr('data-last-heard') ) );
		}, 1000 * 60);
	</script>
</html>
